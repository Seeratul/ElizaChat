<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple React App: Show Channels</title>
    <style>
        /* Basic layout */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .left-panel {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .right-panel {
            flex-grow: 1;
            padding: 20px;
            background-color: white;
            border-left: 2px solid #ddd;
        }

        ul {
            padding-left: 20px;
        }

        li {
            margin: 10px 0;
            cursor: pointer;
        }

        li:hover {
            background-color: #34495e;
            padding: 5px;
        }

        h2 {
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script type="text/babel">

        function ChannelList({ onSelectChannel }) {
            // React component that shows a list of channels

            const [channels, setChannels] = React.useState([]);

            React.useEffect(() => {
                // Fetch list of channels
                fetch("http://vm146.rz.uos.de/hub/channels") // university hub
                    .then(response => response.json())
                    .then(data => setChannels(data.channels));
            }, []);

            return (
                <div className="left-panel">
                    <h2>Channel List</h2>
                    <ul>
                        {channels.map(channel => (
                            <li key={channel.id} onClick={() => onSelectChannel(channel)}>
                                {channel.name} (URL: {channel.endpoint}, Type: {channel.type_of_service})
                            </li>
                        ))}
                    </ul>
                </div>
            );
        }

        const getMessages = async (channel) => {
            try {
                const response = await fetch(channel.endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `authkey ${channel.authkey}`, // inlcuding the authkey, otherwise network errors! 
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to fetch messages from channel ${channel.name}: ${errorData}`);
                }

                const data = await response.json();
                console.log(`Messages from Channel ${channel.name} at ${channel.endpoint} loaded`);
                return data;
            } catch (error) {
                throw new Error(`Failed to fetch messages from channel ${channel.name} at ${channel.endpoint}: ${error.message}`);
            }
        };
        
        function ChannelContent({ selectedChannel }) {
            // React component that shows the messages of a selected channels

            // variables
            const [messages, setMessages] = React.useState([]);
            const [error, setError] = React.useState(null);

            // Fetching Messages with getMessages()
            const fetchMessages = async () => {
                    try {
                            const data = await getMessages(selectedChannel);
                            console.log(data);
                            setMessages(data);
                    } catch (err) {
                        setError(err.message);
                        throw new Error(`Failed to fetch messages from channel ${selectedChannel.name}: ${err.message}`);
                    }
            };

            // Posting of a message
            const handleSubmit = async (e) => {
                e.preventDefault();

                try {
                    const response = await fetch(selectedChannel.endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `authkey ${selectedChannel.authkey}`, // inlcuding the authkey, otherwise network errors! 
                            'Content-Type': 'application/json',
                        },
                        // access form fields
                        body: JSON.stringify({
                            content: document.getElementById('content').value,
                            sender: document.getElementById('sender').value,
                            timestamp: new Date().toISOString()
                        }),
                    })

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Failed to post message to channel ${selectedChannel.name}: ${errorData}`);
                    }
                    const data = await response;
                    fetchMessages(); // fetch messages again to see submitted message appear 
                    // reset form
                    document.getElementById('content').value = null;
                    document.getElementById('sender').value = null;
                    return data;
                } catch (error) {
                    throw new Error(`Failed to post message to channel ${selectedChannel.name}: ${error.message}`);
                }
            };

            React.useEffect(() => {
                if (!selectedChannel) return;

                setError(null);
                
                fetchMessages();
                }, 
                [selectedChannel]
            );

            // if no channel selected
            if (!selectedChannel) {
                return <div className="right-panel">Please select a channel to view its content.</div>;
            }

            return (
                <div className="right-panel">
                    <h2>{selectedChannel.name}</h2>
                    <p>URL: {selectedChannel.endpoint}</p>
                    <p>Type of Service: {selectedChannel.type_of_service}</p>
                    
                   
                    {error && <p style={{ color: 'red' }}>{error}</p>}
                    
                     
                    <h3>Messages:</h3>
                    <ul>
                        {console.log(messages)}
                        {messages.length > 0 ? (
                            messages.map((msg, index) => (
                                <li key={index}>{msg.content} - <em>{msg.sender}</em></li>
                            ))
                        ) : (
                            <p>No messages available.</p>
                        )}
                    </ul>
                    <form>  
                        <label>
                            Name:
                            <input type="text" id="sender" />
                        </label>
                        <label>
                            Message:
                            <input type="text" id="content" />
                        </label>
                        <button onClick={ (e) => {
                            handleSubmit(e);
                            
                        }}>Submit</button>
                    </form>
                </div>

            );
        }      



        function App() {

            // handling of selected Channel
            const [selectedChannel, setSelectedChannel] = React.useState(null);
            const handleSelectChannel = (channel) => {
                setSelectedChannel(channel);
            };

            return (
                <div className="container">
                    <ChannelList onSelectChannel={handleSelectChannel} />
                    <ChannelContent selectedChannel={selectedChannel} />
                </div>
            );
        }

        // Render the App component
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>